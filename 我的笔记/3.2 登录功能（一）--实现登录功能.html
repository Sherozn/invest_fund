<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 7.12 (457935)"/><meta name="author" content="1369822836@qq.com"/><meta name="created" content="2019-08-26 16:15:44 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2019-09-08 06:45:50 +0000"/><title>3.2 登录功能（一）--实现登录功能</title></head><body><div>在本地搭建好后端环境之后，我们来实现登录功能</div><div><br/></div><div>1、安装SDK插件，用来获取用户的openId</div><div><span style="font-family: &quot;Helvetica Neue&quot;;">SDK是server端（也就是后端）的插件，帮助我们很容易的获取openId。openId是微信中</span><span style="font-size: 13px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">用户身份的唯一标识，我们通过openId来识别用户，方便后期的用户管理。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>~/WeChatProjects/truth_hold$ <span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">npm install --save wafer2-client-sdk</span></div><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">//系统返回信息</span></div><div>+ wafer2-client-sdk@2.1.0</div><div>added 1 package from 1 contributor and audited 10626 packages in 10.382s</div></div><div><br/></div><div>&gt; wafer2-client-sdk应用文档</div><div><a href="https://github.com/tencentyun/wafer2-client-sdk" style="font-size: 16px; color: rgb(36, 41, 46);">https://github.com/tencentyun/wafer2-client-sdk</a></div><div><br/></div><div>2、添加授权登录按钮</div><div>编辑src/pages/index/index.vue文件的template部分，添加授权登录的按钮。</div><div><span style="font-size: 13px;">登录按钮是小程序</span><span style="font-size: 13px;">小程序集成的API，</span><span style="font-size: 13px;">规定的登录按钮的写法</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>&lt;!-- 参考代码，无需粘贴</div><div>&lt;template&gt;</div><div>  &lt;div&gt; —&gt;</div><div><br/></div><div><br/></div><div>    &lt;!-- 需要粘贴的部分 --&gt;</div><div>    &lt;button open-type="getUserInfo" lang="zh_CN" class='btn' @getuserinfo="login"&gt;授权登录&lt;/button&gt;</div></div><div><br/></div><div>3、配置登录链接</div><div>编辑src/config.js文件，config.js文件我们用来放配置型的代码，用下面的代码替换掉原先的代码</div><div>登录链接为什么是`<a href="http://localhost:5757/">http://localhost:5757</a>/weapp/login`，后面的课程会具体分析</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>//域名，通过域名来找到服务器，在这里我们将本地电脑当成服务器</div><div>//所以现在配置的域名是本地的，当项目实际上线，这里需要换成实际的已备案的域名</div><div>const host = '<a href="http://localhost:5757">http://localhost:5757</a>'</div><div><br/></div><div>const config = {</div><div>  host,</div><div>  loginUrl: `${host}/weapp/login`</div><div>}</div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div>//我们在【ES6知识点详解】中讲过export的意思是向外暴露接口</div><div>//这样在其他文件中可以通过import config from '@/config'引用</div><div>//然后通过config.loginUrl就能得到在本文件中配置的值'http://localhost:5757/weapp/login'</div><div>export default config</div></div><div><br/></div><div><span style="font-size: 13px;">4、删除测试代码</span></div><div><span style="font-size: 13px;">我们在第二章学习ES6时，在index.vue界面添加了一些代码，现在将这些测试代码删除，删除后&lt;script&gt;部分还剩下下面的代码，</span><span style="font-size: 13px;">&lt;template&gt;、</span><span style="font-size: 13px;">&lt;style&gt;部分暂时不需要改动</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>&lt;script&gt;</div><div>  export default {</div><div>    data () {</div><div>      return {</div><div>        mark:0</div><div>      }</div><div>    },</div><div>    methods: {</div><div>      addMark (add) {</div><div>        this.mark = this.mark + add</div><div>        console.log("mark为：",this.mark)  </div><div>      }</div><div>    },</div><div>    mounted () {</div><div>    }</div><div>  }</div><div>&lt;/script&gt;</div></div><div><br/></div><div><br/></div><div>5、引用配置文件</div><div>在src/pages/index/index.vue文件中添加import引用SDK插件、config.js文件</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">//</span>参考代码，无需粘贴</div><div>//&lt;script&gt;</div><div><br/></div><div><br/></div><div>  //需要粘贴的部分</div><div>  import qcloud from 'wafer2-client-sdk'</div><div>  import config from '@/config'</div><div>  </div><div><br/></div><div>  //参考代码，无需粘贴</div><div>  //export default {</div></div><div><br/></div><div>6、添加登录方法</div><div><span style="font-size: 13px;">编辑index.vue文件，在</span><span style="font-size: 13px;">script的</span><span style="font-size: 13px;">methods对象中添加方法</span><span style="font-size: 13px;">loginSuccess和</span><span style="font-size: 13px;">login</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>//参考代码，无需粘贴</div><div>//methods: {</div><div>  //addMark (add) {</div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">    ...</span></div><div>  //},</div><div><br/></div><div><br/></div><div>  //需要粘贴的部分</div><div>  //登录成功会调用loginSuccess方法</div><div>  loginSuccess (res) {</div><div>    //将用户信息保存到缓存中，wx.setStorageSync是小程序的一个API，用来将信息添加到缓存中</div><div>    wx.setStorageSync('userinfo', res)</div><div>  },</div><div>  login () {</div><div>    //wx.showToast是小程序的消息提示框</div><div>    wx.showToast({</div><div>      title: '登录中',</div><div>      icon: 'loading'</div><div>    })</div><div>    //通过SDK插件，请求config.js中配置的loginUrl路径（<a href="http://localhost:5757/weapp/login">http://localhost:5757/weapp/login</a>）</div><div>    qcloud.setLoginUrl(config.loginUrl)</div><div>    qcloud.login({</div><div>      success: res =&gt; {</div><div>        //登录成功后，显示底部导航栏</div><div>        wx.showTabBar()</div><div>        console.log('登录成功', res)</div><div>        //调用loginSuccess方法，并将用户信息作为参数</div><div>        this.loginSuccess(res)</div><div>      },</div><div>      fail: err =&gt; {</div><div>        console.error('登录失败', err)</div><div>      }</div><div>    })</div><div>  }</div><div><br/></div><div><br/></div><div>//参考代码，无需粘贴</div><div>//},</div></div><div><br/></div><div>7、授权本地域名</div><div>我们再src/config.js文件中定义的域名<a href="http://localhost:5757/">http://localhost:5757</a>，不是一个真正的域名，只有在我们自己电脑上才有效，真正的域名，如<a href="http://localhost:5757/">http://</a>baidu.com所有人都是可以通过网络访问的。</div><div>对于这种不合法的域名，在微信开发者工具中，需要授权一下。</div><div>点击右上角&gt;&gt;图标，点击详情—本地设置，选中不校验合法域名，就可以了~</div><div><img src="3.2%20%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%80%EF%BC%89--%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD.html.resources/CE0D4E94-75A2-4C96-9F29-A51228DA700B.png" height="110" width="147"/><br/></div><div><img src="3.2%20%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%80%EF%BC%89--%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD.html.resources/B4C6525C-45AF-43AF-99AD-FB99AE99A5D9.png" height="356" width="397"/><br/></div><div><br/></div><div>8、测试</div><div>（1）打开终端，进入项目目录，打开两个窗口同时运行npm run dev</div><div>第一个窗口，在项目目录下运行`npm run dev`用来启动前端代码</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>~/WeChatProjects/truth_hold$ npm run dev</div></div><div><br/></div><div>第二个窗口，在server目录下运行`npm run dev`用来启动后端代码</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>~/WeChatProjects/truth_hold/server$ npm run dev</div></div><div><br/></div><div>然后点击授权登录按钮，右侧控制台出现下列信息，说明登录成功了。</div><div>控制台中出现的，就是登录接口获取到的当前登录用户的微信昵称、城市、openId等信息</div><div><img src="3.2%20%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%80%EF%BC%89--%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD.html.resources/07DA889B-4D55-4A84-8CAF-6B81A87AAC66.png" height="746" width="795"/><br/></div><div><br/></div><div>（2）登录可能出现错误--登录失败 Error: 响应错误</div><div><img src="3.2%20%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%80%EF%BC%89--%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD.html.resources/DDC3F51C-0F59-4706-98D6-78FDDCABB24E.png" height="188" width="614"/><br/></div><div><br/></div><div>解决方法：</div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">完善server/</span><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">config.js</span><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">文件中的下列字段</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>qcloudAppId: '必填',</div><div>qcloudSecretId: '必填',</div><div>qcloudSecretKey: '必填',</div><div>// 微信小程序 App ID</div><div>appId: '必填',</div><div>// 微信小程序 App Secret</div><div>appSecret: '必填',</div><div>// 是否使用腾讯云代理登录小程序，设置为false</div><div>useQcloudLogin: false,</div></div><div><br/></div><ul><li><div style="orphans: auto; widows: auto; "><span style="font-size: 16px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">qcloudAppId、</span><span style="font-size: 16px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">qcloudSecretId、</span><span style="font-size: 16px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">qcloudSecretKey这三个参数，我们在上一节已经配置过了。</span></div></li><li><div style="orphans: auto; widows: auto; "><span style="font-size: 16px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">appId、</span><span style="font-size: 16px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">appSecret这两个参数需要在微信公众平台（</span><a href="https://mp.weixin.qq.com/" style="font-size: 16px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">https://mp.weixin.qq.com/</a><span style="font-size: 16px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">）登录小程序账号</span><span style="caret-color: rgb(77, 77, 77); font-size: 16px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">—</span><span style="font-size: 16px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">开发—开发设置中查看。</span></div></li><li><div style="orphans: auto; widows: auto; "><span style="font-size: 16px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">useQcloudLogin参数改为false</span></div></li></ul><div style="orphans: auto; widows: auto; "><span style="font-size: 16px;"><br/></span></div><div><img src="3.2%20%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%80%EF%BC%89--%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD.html.resources/9ADA20F1-331C-4BA6-BF52-2AA16305CEC9.png" height="628" width="1254"/><br/></div><div><br/></div><div><br/></div><div>9、查看数据库</div><div>登录mysql，可以看到cSessionInfo表中已经有一条客户信息了。</div><div>我们主要会用到user_info字段，里面包含了openId、nickName等用户基本的信息。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>mysql&gt; use cAuth;</div><div><br/></div><div>mysql&gt; select * from cSessionInfo;</div><div>| open_id                      | uuid                                 | skey                                     | create_time         | last_visit_time     | session_key              | user_info                                                                                                                                                                                                                                                                                                                                                         </div><div>+------------------------------+--------------------------------------+--------------------</div><div>| oqURH46cYrMV3IwrrflosChndRTI | 88d1f834-bd64-491e-9779-18f3653528cc | dcd4a49ed87a0f4ebdff0f40ee4a53ed5572aa01 | 2019-06-16 11:19:43 | 2019-06-16 20:13:53 | aZha8RCFtrY1mp98kj9hSg== | {"openId":"oqURH46cYrMV3IwrrflosChndRTI","nickName":"ww","gender":2,"language":"zh_CN","city":"Qingdao","province":"Shandong","country":"China","avatarUrl":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ2Te6nOOqiaeiae0WCWxRHKedpM7ZOs8AIU6og0ia1WChutbiaaaibthT7GbrewG0licrkbps8XajcHXzQ/132","watermark":{"timestamp":1560687233,"appid":"wxd2a52ff3594d8d7d"}} |</div><div>+------------------------------+--------------------------------------+--------------------</div><div>1 row in set (0.00 sec)</div></div><div><br/></div><div><br/></div></body></html>