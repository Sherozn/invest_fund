<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 7.12 (457935)"/><meta name="author" content="1369822836@qq.com"/><meta name="created" content="2019-09-08 06:43:35 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2019-09-16 08:49:31 +0000"/><title>3.5 登录功能（三）--获取用户信息</title></head><body><div><span style="font-size: 13px;">1、获取用户信息</span></div><div><span style="font-size: 13px;">我们在实现登录功能时，添加的登录成功时调用的方法</span><span style="font-size: 13px;">loginSuccess。</span></div><div><span style="font-size: 13px;">方法中</span><span style="font-size: 13px;">代码</span><span style="font-size: 13px;">`</span><span style="font-size: 13px;">wx.setStorageSync('userinfo', res)</span><span style="font-size: 13px;">`</span><span style="font-size: 13px;">的作用是将</span><span style="font-size: 13px;">用户信息保存到了缓存中</span><span style="font-size: 13px;">，并</span><span style="font-size: 13px;">将这条缓存信息命名为userinfo。</span></div><div><span style="font-size: 13px;">缓存信息会一直存储在用户的手机中，等到下次打开小程序的时候，小程序会读取微信的缓存，来获得用户信息。如果用户清除了微信的缓存，那么需要用户重新登录小程序。</span></div><div><span style="font-size: 13px;">现在我们从缓存中将用户信息读取出来</span></div><div><br/></div><div><span style="font-size: 13px;">（1）查看缓存数据</span></div><div><br/></div><div><span style="font-size: 13px;"> 打开微信开发者工具，</span><span style="font-size: 13px;">点击控制台中&gt;&gt;图标，会出现Storage，缓存就是保存在这里，点击Storage后，我们看到一条名为userinfo的信息，里面存储的就是用户信息，每条用户信息都会包括openId、nickName等内容</span><span style="font-size: 13px;">。</span></div><div><br/></div><div><img src="3.5%20%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%89%EF%BC%89--%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF.html.resources/3FF32846-A25C-4F21-9680-ABA49533E9C6.png" height="115" width="550"/><br/></div><div><img src="3.5%20%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%89%EF%BC%89--%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF.html.resources/EED7355D-D6DC-4518-8906-2BD0899E187F.png" height="310" width="545"/><br/></div><div><br/></div><div><span style="font-size: 13px;">（2）编辑index.vue文件</span><span style="font-size: 13px;">&lt;</span><span style="font-size: 13px;">script&gt;部分的data</span><span style="font-size: 13px;">对象</span></div><div><span style="font-size: 13px;">添加</span><span style="font-size: 13px;">userinfo变量，用来保存用户信息</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>//参考代码，无需粘贴</div><div>//data () {</div><div>  //return {</div><div>    //mark:0,</div><div><br/></div><div>    </div><div>    //需要粘贴的部分，注意每个变量之间，需要用“,”间隔</div><div>    userinfo:{}</div><div><br/></div><div>  </div><div>  //参考代码，无需粘贴</div><div>  //}</div><div>//},</div></div><div><br/></div><div><span style="font-size: 13px;">（3）获取用户信息</span></div><div><span style="font-size: 13px;">编辑</span><span style="font-size: 13px;">index.vue文件</span><span style="font-size: 13px;">&lt;</span><span style="font-size: 13px;">script&gt;部分的</span><span style="font-size: 13px;">mounted对象</span></div><div><br/></div><div><span style="font-size: 13px;">每次打开小程序先从缓存中读取是否有</span><span style="font-size: 13px;">名为userinfo的信息，</span><span style="font-size: 13px;">如果有，说明用户登录了，打开小程序会直接显示首页；如果没有，说明用户还未登录，打开小程序显示登录弹窗，提示登录</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>//mounted是vue生命周期方法，在页面渲染完成后执行</div><div>mounted () {</div><div>  //获取缓存中名为userinfo的信息</div><div>  const userinfo = wx.getStorageSync('userinfo')</div><div>  //如果缓存中有userinfo的信息，说明用户登录了</div><div>  if(userinfo.openId){</div><div>    //将用户信息保存到data对象我们刚刚添加的userinfo变量中</div><div>    this.userinfo = userinfo</div><div>  }else{</div><div>    //如果当前用户没有缓存信息，则隐藏掉TabBar，从而实现在授权登录的页面不显示TabBar的效果</div><div>    wx.hideTabBar()</div><div>  }</div><div>}</div></div><div><br/></div><div><span style="font-size: 13px;">（4）查看效果</span></div><div><span style="font-size: 13px;">command+c保存代码后，开发者工具会自动刷新效果，如果没有刷新，可以点击编辑自己手动刷新，如果没有看到应该出现的效果，就需要查看终端，看看是不是有报错</span></div><div><img src="3.5%20%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%89%EF%BC%89--%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF.html.resources/7BCF17F7-EA97-4A58-A6C6-68B652BEAD61.png" height="877" width="911"/><br/></div><div><br/></div><div><span style="font-size: 13px;">2、登录弹窗显示控制</span></div><div><span style="font-size: 13px;">实现的效果：在点击「授权登录」按钮后，隐藏登录弹窗</span></div><div><br/></div><div><span style="font-size: 13px;">（1）</span><span style="font-size: 13px;">编辑</span><span style="font-size: 13px;">index.vue文件</span><span style="font-size: 13px;">&lt;</span><span style="font-size: 13px;">script&gt;部分的data</span><span style="font-size: 13px;">对象</span></div><div><span style="font-size: 13px;">添加</span><span style="font-size: 13px;">showLogin</span><span style="font-size: 13px;">变量，用来控制登录弹窗是否显示</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>//参考代码，无需粘贴</div><div>//userinfo:{}</div><div><br/></div><div><br/></div><div>//需要粘贴的部分，设置默认值为false</div><div>showLogin:false</div></div><div><br/></div><div><span style="font-size: 13px;">（2）</span><span style="font-size: 13px;">编辑</span><span style="font-size: 13px;">index.vue文件</span><span style="font-size: 13px;">&lt;</span><span style="font-size: 13px;">script&gt;部分的</span><span style="font-size: 13px;">mounted对象</span></div><div><span style="font-size: 13px;">当没有从</span><span style="font-size: 13px;">缓存中读取</span><span style="font-size: 13px;">名为userinfo的信息，说明用户没有登录，那就应该显示登录弹窗，将</span><span style="font-size: 13px;">showLogin改为true</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>//参考代码，无需粘贴</div><div>//}else{</div><div> //wx.hideTabBar()</div><div><br/></div><div><br/></div><div>//需要粘贴的部分</div><div> this.showLogin = true</div></div><div><br/></div><div><span style="font-size: 13px;">（3）</span><span style="font-size: 13px;">编辑template部分</span></div><div><span style="font-size: 13px;">用一个&lt;div&gt;标签将登录弹窗部分的页面代码包起来，然后通过vue的语法v-if来控制登录弹窗是否显示</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>&lt;!-- 需要粘贴的部分 —&gt;</div><div>&lt;!-- v-if是vue的语法，判断语句，当showLogin为true时，显示v-if所在标签包含的部分，也就是登录弹窗页面 --&gt;</div><div>&lt;div v-if="showLogin"&gt;</div><div><br/></div><div><br/></div><div>  &lt;!-- 参考代码，无需粘贴</div><div>  &lt;LoginWindow&gt;&lt;/LoginWindow&gt;</div><div><br/></div><div><br/></div><div>&lt;!-- 需要粘贴的部分 --&gt;</div><div>&lt;/div&gt;</div></div><div><br/></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">3、子组件</span><span style="font-size: 13px;">向</span><span style="font-size: 13px;">父组件传递信息</span></div><div><span style="font-size: 13px;">上一步完成之后，点击授权登录按钮，登录弹窗还是存在，没有消失，因为在登录成功之后，没有将</span><span style="font-size: 13px;">showLogin改为false，需要在login方法中操作</span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">但是login方法在</span><span style="font-size: 13px;">LoginWindow.vue文件中，这个文件是我们上一节创建的子组件，index.vue文件是他的父组件</span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">我们下面演示</span><span style="font-size: 13px;">子组件向父组件传递信息，即</span><span style="font-size: 13px;">在子组件中告诉父组件，将</span><span style="font-size: 13px;">showLogin变量改为false，从而控制登录弹窗消失</span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">（1）编辑子组件，也就是LoginWindow.vue文件，在</span><span style="font-size: 13px;">this.$emit中添加需要传递的信息</span></div><div><span style="font-size: 13px;">编辑&lt;</span><span style="font-size: 13px;">script&gt;部分，methods对象中的login方法，将要传递的信息命名为</span><span style="font-size: 13px;">changeShow</span><span style="font-size: 13px;">，后面跟着要传递的信息，第一个信息是false，第二个信息res是用户信息</span><br/></div><div><span style="font-size: 13px;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>//参考代码，无需粘贴</div><div>//qcloud.login({</div><div>//  success: res =&gt; {</div><div><br/></div><div><br/></div><div>      //需要粘贴的部分</div><div>      this.$emit('changeShow',false,res)</div><div><br/></div><div><br/></div><div>      //参考代码，无需粘贴</div><div>      //wx.showTabBar()</div></div><div><br/></div><div>（2）编辑父组件，也就是index.vue文件，读取子组件传递的信息</div><div><span style="font-size: 13px;">在template中的HTML组件元素上面，将从子组件中传递过来的信息名称</span><span style="font-size: 13px;">changeShow</span><span style="font-size: 13px;">指向一个方法，并且在该方法中读取信息</span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">1）在</span><span style="font-size: 13px;">&lt;LoginWindow&gt;标签上面，将</span><span style="font-size: 13px;">信息名称</span><span style="font-size: 13px;">changeShow指向</span><span style="font-size: 13px;">getModel方法，并传递参数</span><span style="font-size: 13px;">arguments，这个参数包含着我们要传递的信息</span></div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>&lt;LoginWindow @changeShow="getModel(arguments)"&gt;&lt;/LoginWindow&gt;</div></div></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">2）在script标签中methods对象中添加方法getModel</span></div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">//参考代码，无需粘贴</span></div><div>//addMark (add) {</div><div>  //...</div><div>//},</div><div><br/></div><div><br/></div><div>//需要粘贴的部分</div><div>getModel (arguments) {</div><div>  console.log("arguments",arguments)</div><div>  //将第一个信息false赋值到showLogin变量中，控制登录弹窗消息</div><div>  this.showLogin = val[0]</div><div>  //将第二个信息赋值到userinfo变量中</div><div>  this.userinfo = val[1]</div><div>}</div></div></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">3）疑问解答</span></div><div><span style="font-size: 13px;">有的同学可能会问，</span><span style="font-size: 13px;">index.vue文件的mounted中已经获取到用户信息了，为什么在</span><span style="font-size: 13px;">getModel还要再一次将用户信息赋值到</span><span style="font-size: 13px;">userinfo中，这个涉及到mounted的触发了，大家可以了解一下</span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">mounted在页面加载完成后，会触发一下，如果用户没有退出小程序，这个页面就是存储在页面栈中，如果页面栈空间足够的话，页面就不会再次重新加载了，mounted也不会再次被触发。</span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">可以这样理解，一般情况下，打开小程序后，</span><span style="font-size: 13px;">mounted只会被触发一次</span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;"><span>当用户未登录，</span></span><span style="font-size: 13px;">因为缓存中没有userinfo的信息，</span><span style="font-size: 13px;">触发</span><span style="font-size: 13px;">mounted后，</span><span style="font-size: 13px;">userinfo变量还是空的</span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">当用户登录成功后，</span><span style="font-size: 13px;">缓存有了userinfo的信息，但是</span><span style="font-size: 13px;">mounted不会再被触发，此时</span><span style="font-size: 13px;">userinfo变量仍然是空的，所以需要在</span><span style="font-size: 13px;">getModel方法中给userinfo赋值</span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;"><br/></span></div><div><span style="font-size: 13px;">3、测试效果</span><br/></div><div><span style="font-size: 13px;">在Storage中删除掉缓存信息，点击编译按钮刷新页面，点击授权登录按钮，就会出现我们下面演示的效果</span></div><div><img src="3.5%20%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%EF%BC%88%E4%B8%89%EF%BC%89--%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF.html.resources/53483119-6758-4886-9680-CC677AB899F1.png" height="595" width="644"/><br/></div><div><br/></div><div><br/></div></body></html>